<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta name="keywords" content=""><meta name="description" content="Sshwy 的个人博客"><meta name="generator" content="Hexo 6.3.0"><title>树状数组全讲 - Sshwy&#39;s Notes</title><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/ssimple.css?20250423.css"><link rel="stylesheet" href="/iconfont/iconfont.css?20250423.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" crossorigin="anonymous"></script><script>document.addEventListener("DOMContentLoaded",function(){window.renderKatex()})</script></head><body><header><div class="header" style="width:100%"><div class="header-inner" style="position:fixed;z-index:20;top:0;left:0"><div class="header-content" style="max-width:1200px;margin:auto"><div class="blog-title"><span class="iconfont icon-menu1" id="menu-button"></span> <a href="/" class="logo header-title">Sshwy&#39;s Notes</a><div class="mobile-search"><input type="text"> <span class="iconfont icon-search mobile-search-icon"></span> <span class="iconfont icon-baseline-close-px search-close-icon"></span></div></div><div class="navbar" id="menu-list"><ul class="menu"><li class="menu-item"><a href="/archives/" class="menu-item-link"><span class="menu-item-icon iconfont icon-work"></span> Archives</a></li><li class="menu-item"><a href="/directory/" class="menu-item-link"><span class="menu-item-icon iconfont icon-folder-close"></span> Directory</a></li><li class="menu-item"><a href="/about/" class="menu-item-link"><span class="menu-item-icon iconfont icon-user"></span> About</a></li><li class="menu-item"><a href="/static/beibishi2023" class="menu-item-link"><span class="menu-item-icon iconfont icon-favorite"></span> NOI 背笔试</a></li></ul></div><div class="search"><input type="text"> <span class="iconfont icon-search search-icon"></span> <span class="iconfont icon-baseline-close-px search-close-icon"></span></div></div></div><div class="search-shadow"></div><div class="search-box"><div class="search-container"><div class="search-container-inner"><div class="search-data-status"><span>Fetching search data...</span></div><div class="search-count"></div><div class="search-result"></div></div></div></div></div></header><main class="main"><article class="post"><div class="post-title"><h1 class="page-title">树状数组全讲</h1></div><div class="post-meta"><div class="post-info"><span class="post-info-item post-time" title="2021年1月29日星期五下午3点34分 (CST+08:00)"><span class="info-icon iconfont icon-time"></span>更新于 2021年1月29日 </span><span class="icon infosep"></span><span class="post-info-item post-wordcount"> <span class="info-icon iconfont icon-text"></span>约 2,741 字</span></div><div class="post-directory"><span class="iconfont icon-folder-close"></span> <a class="directory" href="/directory">Home</a> <a class="directory" href="/directory/"></a> <span class="icon smallarrow"></span> <a class="directory" href="/directory/Data-Structure/">数据结构 </a><span class="icon smallarrow"></span> 当前文章</div><div class="post-tags"><span class="tag"><span class="meta-icon iconfont icon-tag"></span><a class="tag" href="/tags/Notes/">Notes</a></span></div><hr></div><div class="toc"><h2 class="toc-title"><span class="iconfont icon-explain" style="font-size:1em;padding-right:5px"></span>文章目录</h2><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Lowbit"><span class="toc-number">1.</span> <span class="toc-text">Lowbit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#树状数组"><span class="toc-number">2.</span> <span class="toc-text">树状数组</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#单点修改与单点查询"><span class="toc-number">2.1.</span> <span class="toc-text">单点修改与单点查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#区间修改与单点查询"><span class="toc-number">2.2.</span> <span class="toc-text">区间修改与单点查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#区间修改与区间查询"><span class="toc-number">2.3.</span> <span class="toc-text">区间修改与区间查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#树状数组上二分"><span class="toc-number">2.4.</span> <span class="toc-text">树状数组上二分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二维树状数组"><span class="toc-number">3.</span> <span class="toc-text">二维树状数组</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#单点修改与单点查询-1"><span class="toc-number">3.1.</span> <span class="toc-text">单点修改与单点查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#区间修改与单点查询-1"><span class="toc-number">3.2.</span> <span class="toc-text">区间修改与单点查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#区间修改与区间查询-1"><span class="toc-number">3.3.</span> <span class="toc-text">区间修改与区间查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#模板"><span class="toc-number">3.3.1.</span> <span class="toc-text">模板</span></a></li></ol></li></ol></li></ol></div><hr></div><div class="post-content"><h2><a id="Lowbit" href="#Lowbit" class="headerlink" title="Lowbit"></a>Lowbit</h2><p>我们定义<script type="math/tex">\operatorname{lowbit}(x)</script>表示 x 的二进制最低位的 1 及其后面的 0 构成的数，或者用位运算可以表示为</p><script type="math/tex;mode=display">\operatorname{lowbit}(x)=x\wedge (-x)=x-x\wedge(x-1)</script><p>其中<script type="math/tex">x\wedge (-x)</script>利用了补码的性质。</p><h2><a id="树状数组" href="#树状数组" class="headerlink" title="树状数组"></a>树状数组</h2><p>树状数组<script type="math/tex">c_1,\ldots,c_n</script>是基于一个序列<script type="math/tex">a_1,\ldots, a_n</script>建立的：</p><script type="math/tex;mode=display">c_i=\sum_{j=i-\operatorname{lowbit}(i)+1}^ia_j</script><p>即从<script type="math/tex">j</script>往前数<script type="math/tex">\operatorname{lowbit}(i)</script>个数的和。</p><p>树状数组用于维护前缀和。广义地说，树状数组可以维护可减信息（或者不涉及到减法的信息）。</p><h3><a id="单点修改与单点查询" href="#单点修改与单点查询" class="headerlink" title="单点修改与单点查询"></a>单点修改与单点查询</h3><p>修改：容易想到，把包含这个点的值都更新一遍：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> p<span class="token punctuation">,</span><span class="token keyword">int</span> v<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>p<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token function">lowbit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+=</span>v<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>查询：把前缀的<script type="math/tex">\operatorname{lowbit}</script>段都加起来：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">pre</span><span class="token punctuation">(</span><span class="token keyword">int</span> p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>p<span class="token punctuation">;</span>i<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">-=</span><span class="token function">lowbit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>res<span class="token operator">+=</span>c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><a id="区间修改与单点查询" href="#区间修改与单点查询" class="headerlink" title="区间修改与单点查询"></a>区间修改与单点查询</h3><p>区间加上一个数，我们可以维护差分数组<script type="math/tex">d_i=a_i-a_{i-1},d_1=a_1</script>。于是区间修改可以转化为差分数组上两个单点修改，单点查询就转化为差分数组上前缀和查询：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
 * add(int,int), pre(int) 即上文所定义
 */</span>
<span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> l<span class="token punctuation">,</span><span class="token keyword">int</span> r<span class="token punctuation">,</span><span class="token keyword">int</span> v<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">int</span> p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">pre</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><a id="区间修改与区间查询" href="#区间修改与区间查询" class="headerlink" title="区间修改与区间查询"></a>区间修改与区间查询</h3><p>区间查询可以转化为两个前缀和查询。则我们考虑差分数组上的前缀和查询。我们约定记号<script type="math/tex">F(\left\langle A_i\right\rangle,x)</script>表示在序列<script type="math/tex">\left\langle A_i\right\rangle _{i=1}^n</script>上的前<script type="math/tex">x</script>个数的和（前缀和），则可以推一推得到：</p><script type="math/tex;mode=display">\begin{aligned}
F(a,x)&=\sum_{i=1}^xa_i=\sum_{i=1}^x\sum_{j=1}^id_j\\
&=\sum_{j=1}^xd_j(x-j+1)\\
&=(x+1)\sum_{j=1}^xd_j-\sum_{j=1}^xd_j\cdot j\\
&=(x+1)F(\left\langle d_i\right\rangle,x)-F(\left\langle d_i\cdot i\right\rangle,x)
\end{aligned}</script><p>于是我们维护两个数组的前缀和即可。区间修改则转化为单点修改，在两个数组上都做一遍即可。</p><h3><a id="树状数组上二分" href="#树状数组上二分" class="headerlink" title="树状数组上二分"></a>树状数组上二分</h3><p>更准确地说，是在树状数组上倍增。例如，求<script type="math/tex">\sum_{j=1}^i a_j \le T</script>的最大的<script type="math/tex">i</script>。根据树状数组的结构，我我们判断一下是否跳过下一子树，或者进入下一子树：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">int</span> T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> curA <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span> j<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> nex <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>j<span class="token punctuation">)</span> <span class="token operator">+</span> cur<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>nex <span class="token operator">>=</span> N<span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> nexA <span class="token operator">=</span> curA <span class="token operator">+</span> A<span class="token punctuation">[</span>nex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>nexA <span class="token operator">&lt;=</span> T<span class="token punctuation">)</span> cur <span class="token operator">=</span> nex<span class="token punctuation">,</span> curA <span class="token operator">=</span> nexA<span class="token operator">:</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> cur<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2><a id="二维树状数组" href="#二维树状数组" class="headerlink" title="二维树状数组"></a>二维树状数组</h2><p>推广得到，对于矩阵<script type="math/tex">[a_{ij}]_{1\le i\le n,\,1\le j\le m}</script>建立二维树状数组（矩阵）<script type="math/tex">[c_{ij}]</script>：</p><script type="math/tex;mode=display">c_{ij}=\sum_{x=i-\operatorname{lowbit}(i)+1}^i\sum_{y=j-\operatorname{lowbit}(j)+1}^ja_{xy}</script><h3><a id="单点修改与单点查询-1" href="#单点修改与单点查询-1" class="headerlink" title="单点修改与单点查询"></a>单点修改与单点查询</h3><p>修改：同理：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span><span class="token keyword">int</span> y<span class="token punctuation">,</span><span class="token keyword">int</span> v<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>x<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token function">lowbit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>y<span class="token punctuation">;</span>j<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>j<span class="token operator">+=</span><span class="token function">lowbit</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+=</span>v<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查询：同理：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">pre</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>x<span class="token punctuation">;</span>i<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">-=</span><span class="token function">lowbit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>y<span class="token punctuation">;</span>j<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">-=</span><span class="token function">lowbit</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            res<span class="token operator">+=</span>c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><a id="区间修改与单点查询-1" href="#区间修改与单点查询-1" class="headerlink" title="区间修改与单点查询"></a>区间修改与单点查询</h3><p>这里的区间修改指修改一个子矩阵。类似的，我们也定义一个二维上的差分数组。即</p><script type="math/tex;mode=display">a_{ij}=\sum_{x=1}^i\sum_{y=1}^jd_{xy}</script><p>而注意到</p><script type="math/tex;mode=display">a_{ij-1}+a_{i-1j}-a_{i-1j-1}+d_{ij}=a_{ij}</script><p>于是我们得到了<script type="math/tex">d_{ij}</script>的公式：</p><script type="math/tex;mode=display">d_{ij}=a_{ij}-a_{ij-1}-a_{i-1j}+a_{i-1j-1}</script><p>而区间修改，则可以转化为差分数组上 4 个单点的修改，于是有</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
 * add(int,int,int), pre(int,int) 即上文所定义
 */</span>
<span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> rL<span class="token punctuation">,</span><span class="token keyword">int</span> rR<span class="token punctuation">,</span><span class="token keyword">int</span> cL<span class="token punctuation">,</span><span class="token keyword">int</span> cR<span class="token punctuation">,</span><span class="token keyword">int</span> v<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>rL<span class="token punctuation">,</span>cL<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>rL<span class="token punctuation">,</span>cR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>rR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>cL<span class="token punctuation">,</span><span class="token operator">-</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add</span><span class="token punctuation">(</span>rR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>cR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">pre</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3><a id="区间修改与区间查询-1" href="#区间修改与区间查询-1" class="headerlink" title="区间修改与区间查询"></a>区间修改与区间查询</h3><p>我们约定记号<script type="math/tex">F([A_{ij}],x,y)</script>表示在矩阵<script type="math/tex">[A_{ij}]_{1\le i\le n,\,1\le j\le m}</script>上的<script type="math/tex">\sum_{1\le i\le x,\,1\le j\le y}A_{ij}</script>的和（二维前缀和）：</p><script type="math/tex;mode=display">\begin{aligned}
F([a_{ij}],x,y)=&\sum_{i=1}^x\sum_{j=1}^ya_{ij}
=\sum_{i=1}^x\sum_{j=1}^y\sum_{p=1}^i\sum_{q=1}^jd_{pq}\\
=&\sum_{p=1}^x\sum_{q=1}^yd_{pq}(x-p+1)(y-q+1)\\
=&\sum_{p=1}^x\sum_{q=1}^yd_{pq}\left((x+1)(y+1)-(x+1)q-p(y+1)+pq\right)\\
=&(x+1)(y+1)F([d_{ij}],x,y)-(x+1)F([d_{ij}\cdot j],x,y)\\
&-(y+1)F([d_{ij}\cdot i],x,y)+F([d_{ij}\cdot i\cdot j],x,y)
\end{aligned}</script><p>于是维护 4 个树状数组即可。单点修改的时候给 4 个都改一下。</p><h4><a id="模板" href="#模板" class="headerlink" title="模板"></a>模板</h4><p>ZROI1011</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;bits/stdc++.h></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FOR</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">ROF</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">>=</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">--</span>i<span class="token punctuation">)</span></span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">lowbit</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span>x<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token keyword">int</span> n<span class="token punctuation">,</span>P<span class="token punctuation">,</span>q<span class="token punctuation">,</span>op<span class="token punctuation">,</span>las<span class="token punctuation">;</span>
<span class="token keyword">short</span> s<span class="token punctuation">[</span><span class="token number">8010</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">8010</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span> r<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span> c<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span> val<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span>val<span class="token operator">%</span>P<span class="token punctuation">,</span>val<span class="token operator">*</span>c<span class="token operator">%</span>P<span class="token punctuation">,</span>val<span class="token operator">*</span>r<span class="token operator">%</span>P<span class="token punctuation">,</span>val<span class="token operator">*</span>r<span class="token operator">*</span>c<span class="token operator">%</span>P<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token operator">=</span>r<span class="token punctuation">;</span>x<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>x<span class="token operator">+=</span><span class="token function">lowbit</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token operator">=</span>c<span class="token punctuation">;</span>y<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>y<span class="token operator">+=</span><span class="token function">lowbit</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
        s<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>s<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span>P<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span> r<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span> c<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token operator">=</span>r<span class="token punctuation">;</span>x<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">;</span>x<span class="token operator">-=</span><span class="token function">lowbit</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token operator">=</span>c<span class="token punctuation">;</span>y<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">;</span>y<span class="token operator">-=</span><span class="token function">lowbit</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
        a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>s<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span>P<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>c<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>P<span class="token operator">*</span>a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token punctuation">(</span>r<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token punctuation">(</span>c<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span>P<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span><span class="token operator">&amp;</span>q<span class="token punctuation">,</span><span class="token operator">&amp;</span>P<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>q<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> rL<span class="token punctuation">,</span>rR<span class="token punctuation">,</span>cL<span class="token punctuation">,</span>cR<span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d%d%d%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>op<span class="token punctuation">,</span><span class="token operator">&amp;</span>rL<span class="token punctuation">,</span><span class="token operator">&amp;</span>rR<span class="token punctuation">,</span><span class="token operator">&amp;</span>cL<span class="token punctuation">,</span><span class="token operator">&amp;</span>cR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rL<span class="token operator">=</span><span class="token punctuation">(</span>rL<span class="token operator">+</span>las<span class="token punctuation">)</span><span class="token operator">%</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    rR<span class="token operator">=</span><span class="token punctuation">(</span>rR<span class="token operator">+</span>las<span class="token punctuation">)</span><span class="token operator">%</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    cL<span class="token operator">=</span><span class="token punctuation">(</span>cL<span class="token operator">+</span>las<span class="token punctuation">)</span><span class="token operator">%</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    cR<span class="token operator">=</span><span class="token punctuation">(</span>cR<span class="token operator">+</span>las<span class="token punctuation">)</span><span class="token operator">%</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rL<span class="token operator">></span>rR<span class="token punctuation">)</span><span class="token function">swap</span><span class="token punctuation">(</span>rL<span class="token punctuation">,</span>rR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cL<span class="token operator">></span>cR<span class="token punctuation">)</span><span class="token function">swap</span><span class="token punctuation">(</span>cL<span class="token punctuation">,</span>cR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>op<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token function">add</span><span class="token punctuation">(</span>rL<span class="token punctuation">,</span>cL<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">add</span><span class="token punctuation">(</span>rL<span class="token punctuation">,</span>cR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">add</span><span class="token punctuation">(</span>rR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>cL<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">add</span><span class="token punctuation">(</span>rR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>cR<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">int</span> ans<span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">query</span><span class="token punctuation">(</span>rR<span class="token punctuation">,</span>cR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">query</span><span class="token punctuation">(</span>rL<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>cR<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">query</span><span class="token punctuation">(</span>rR<span class="token punctuation">,</span>cL<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">query</span><span class="token punctuation">(</span>rL<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>cL<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">%</span>P<span class="token punctuation">;</span>
      ans<span class="token operator">=</span><span class="token punctuation">(</span>ans<span class="token operator">+</span>P<span class="token punctuation">)</span><span class="token operator">%</span>P<span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>ans<span class="token punctuation">)</span><span class="token punctuation">,</span>las<span class="token operator">=</span><span class="token punctuation">(</span>las<span class="token operator">+</span>ans<span class="token punctuation">)</span><span class="token operator">%</span>n<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><hr><h3><span class="iconfont icon-history" style="padding-right:5px;font-size:1em"></span>修订记录</h3><div class="post-history-list"><ol reversed><li class="post-history-item">2021年1月29日 第2次修订</li><li class="post-history-item">2019年10月13日 创建文章</li></ol></div><div class="post-footer"><hr><div class="next-post"><span class="iconfont icon-arrow-left-circle"></span> <a href="/Math/Polynomial/OGF/">普通生成函数学习笔记</a></div><div class="prev-post"><a href="/Graph/Tri-Four-Cycle/">三元环与四元环计数 </a><span class="iconfont icon-arrow-right-circle"></span></div></div></article></main></body><div class="side-button"><div id="comment-button" class="button" title="Valine Comment"><span class="iconfont icon-comment"></span></div><div id="darkmode-button" class="button" title="Switch between day and night"><span class="iconfont icon-moonbyueliang"></span></div><div id="top" class="button" title="Back to top"><span class="iconfont icon-arrowup"></span></div></div><footer id="footer" style="margin:3em 0 2em 0;text-align:center;line-height:1.4em"><span class="post-wordcount iconfont icon-text"></span> 全站约 404,069 字<div class="license" style="padding:0 10px"><span>本站所有文章遵循许可协议 <a target="_blank" rel="license noreferrer noopener" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a></span></div><div class="credit"><span>Themed <a href="https://github.com/sshwy/hexo-theme-essence" target="_blank" rel="noreferrer noopener">Essence v1.9.11</a> | Powered by <a href="http://hexo.io" target="_blank" rel="noreferrer noopener">Hexo</a></span></div><div class="friends"><span class="friend-link-span">友情链接 </span><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://carol-xrl.github.io/"><span class="friend-link-span">Carol </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/GavinZheng"><span class="friend-link-span">GavinZheng </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xryjr233"><span class="friend-link-span">xryjr233 </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/dysyn1314"><span class="friend-link-span" title="为什么我的头常常变绿？因为…… "><span style="font-weight:700"><span class="codeforces p">dy</span><span class="codeforces m">syn</span><span class="codeforces p">1314</span></span> </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://blog.aor.sd.cn"><span class="friend-link-span">RainAir </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/lcyfrog"><span class="friend-link-span">lcyfrog </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/maoyiting"><span class="friend-link-span">/hanx/se</span></a></div><div class="copyright"><span>Copyright &copy; 2019-present - Sshwy</span></div></footer><script src="/js/ssimple.js?20250423.js"></script><script src="https://pv.sohu.com/cityjson?ie=utf-8.js" defer></script></html>