<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta name="keywords" content=""><meta name="description" content="Sshwy 的个人博客"><meta name="generator" content="Hexo 6.3.0"><title>长链剖分学习笔记 - Sshwy&#39;s Notes</title><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/ssimple.css?20250423.css"><link rel="stylesheet" href="/iconfont/iconfont.css?20250423.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" crossorigin="anonymous"></script><script>document.addEventListener("DOMContentLoaded",function(){window.renderKatex()})</script></head><body><header><div class="header" style="width:100%"><div class="header-inner" style="position:fixed;z-index:20;top:0;left:0"><div class="header-content" style="max-width:1200px;margin:auto"><div class="blog-title"><span class="iconfont icon-menu1" id="menu-button"></span> <a href="/" class="logo header-title">Sshwy&#39;s Notes</a><div class="mobile-search"><input type="text"> <span class="iconfont icon-search mobile-search-icon"></span> <span class="iconfont icon-baseline-close-px search-close-icon"></span></div></div><div class="navbar" id="menu-list"><ul class="menu"><li class="menu-item"><a href="/archives/" class="menu-item-link"><span class="menu-item-icon iconfont icon-work"></span> Archives</a></li><li class="menu-item"><a href="/directory/" class="menu-item-link"><span class="menu-item-icon iconfont icon-folder-close"></span> Directory</a></li><li class="menu-item"><a href="/about/" class="menu-item-link"><span class="menu-item-icon iconfont icon-user"></span> About</a></li><li class="menu-item"><a href="/static/beibishi2023" class="menu-item-link"><span class="menu-item-icon iconfont icon-favorite"></span> NOI 背笔试</a></li></ul></div><div class="search"><input type="text"> <span class="iconfont icon-search search-icon"></span> <span class="iconfont icon-baseline-close-px search-close-icon"></span></div></div></div><div class="search-shadow"></div><div class="search-box"><div class="search-container"><div class="search-container-inner"><div class="search-data-status"><span>Fetching search data...</span></div><div class="search-count"></div><div class="search-result"></div></div></div></div></div></header><main class="main"><article class="post"><div class="post-title"><h1 class="page-title">长链剖分学习笔记</h1></div><div class="post-meta"><div class="post-info"><span class="post-info-item post-time" title="2021年3月28日星期日下午2点53分 (CST+08:00)"><span class="info-icon iconfont icon-time"></span>更新于 2021年3月28日 </span><span class="icon infosep"></span><span class="post-info-item post-wordcount"> <span class="info-icon iconfont icon-text"></span>约 3,483 字</span></div><div class="post-directory"><span class="iconfont icon-folder-close"></span> <a class="directory" href="/directory">Home</a> <a class="directory" href="/directory/"></a> <span class="icon smallarrow"></span> <a class="directory" href="/directory/Data-Structure/">数据结构 </a><span class="icon smallarrow"></span> 当前文章</div><div class="post-tags"><span class="tag"><span class="meta-icon iconfont icon-tag"></span><a class="tag" href="/tags/Notes/">Notes</a></span></div><hr></div><div class="toc"><h2 class="toc-title"><span class="iconfont icon-explain" style="font-size:1em;padding-right:5px"></span>文章目录</h2><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#重链剖分"><span class="toc-number">1.</span> <span class="toc-text">重链剖分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#高度"><span class="toc-number">2.</span> <span class="toc-text">高度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k-级祖先"><span class="toc-number">3.</span> <span class="toc-text">k 级祖先</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cookies"><span class="toc-number">4.</span> <span class="toc-text">Cookies</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#谈笑风生"><span class="toc-number">5.</span> <span class="toc-text">谈笑风生</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#攻略"><span class="toc-number">6.</span> <span class="toc-text">攻略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HOTEL-加强版"><span class="toc-number">7.</span> <span class="toc-text">HOTEL 加强版</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重建计划"><span class="toc-number">8.</span> <span class="toc-text">重建计划</span></a></li></ol></div><hr></div><div class="post-content"><h2><a id="重链剖分" href="#重链剖分" class="headerlink" title="重链剖分"></a>重链剖分</h2><p>重链剖分（heavy path decomposition）<sup><a id="reffn_1" class="headerlink" title="1"></a><a href="#fn_1">1</a></sup>时，每个内部结点都会选择一个儿子做为自己链上的儿子，我们称为<strong>继承儿子</strong>（重儿子）。如果一个结点没有被继承，那么它就是一个<strong>链顶结点</strong>。一棵树剖分过后链的个数是<script type="math/tex">\Theta(Leaf)</script>的，其中<script type="math/tex">Leaf</script>表示叶子结点的个数。</p><p>按照树剖后的顺序先遍历继承儿子，然后遍历其他儿子，那么每条链上的结点的 DFS 序（DFS order）是连续的。这样可以用一个指针数组来模拟二维数组，于是就可以方便地进行一些 DP 转移。</p><h2><a id="高度" href="#高度" class="headerlink" title="高度"></a>高度</h2><p>设<script type="math/tex">h(u)</script>表示<script type="math/tex">u</script>的<strong>高度</strong>，则</p><script type="math/tex;mode=display">h(u)=\max_{v\in Son(u)}h(v)+1</script><p>关于高度的性质：<script type="math/tex">u</script>所在的链长度<strong>至少</strong>为<script type="math/tex">h(u)</script>。</p><p>注意区分<strong>深度</strong>：<script type="math/tex">dep(u)=dep(F_u)+1</script>。</p><p>长链剖分（long path decomposition）指将高度最高的儿子结点作为继承儿子的一种剖分。</p><p>形式化地，长链剖分中每个内部结点选择的是其儿子中高度最大的点作为继承结点，设其为<script type="math/tex">R_u</script>。</p><p>对于子树合并类的信息，在 DFS 的过程中对于每个结点<script type="math/tex">u</script>，如果</p><ul><li>结点<script type="math/tex">u</script>维护的信息量是<script type="math/tex">O(h(u))</script>的。</li><li><script type="math/tex">u</script>可<script type="math/tex">O(1)</script>继承<script type="math/tex">R_u</script>的信息。</li><li>合并两个大小分别为<script type="math/tex">x, y</script>的信息的复杂度可以做到<script type="math/tex">\min(x, y)</script>。</li></ul><p>那么我们可以利用长链剖分做<script type="math/tex">O(n)</script>离线计算每个结点的信息。具体方法是<script type="math/tex">u</script>继承<script type="math/tex">R_u</script>的信息，然后合并其他儿子的信息。复杂度可表示为</p><script type="math/tex;mode=display">\sum_{u\in T} \sum_{v\in \text{son}(u), v\ne R_u} h(v)</script><p><script type="math/tex">h(v)</script>可以理解为是<script type="math/tex">v</script>的长链之一。由于<script type="math/tex">v\ne  R_u</script>，因此<script type="math/tex">v</script>本身是轻儿子，也就是说<script type="math/tex">v</script>是链顶。因此上述和式本质上就是所有树链的长度和，显然是<script type="math/tex">O(n)</script>的。</p><h2><a id="k-级祖先" href="#k-级祖先" class="headerlink" title="k 级祖先"></a>k 级祖先</h2><blockquote><p>给一棵<script type="math/tex">n</script>度有根树，<script type="math/tex">q</script>次询问点<script type="math/tex">x</script>的<script type="math/tex">k</script>级祖先。</p></blockquote><p>这题可以容易地<script type="math/tex">O(n)-O(n)</script>、<script type="math/tex">O(n\log_2n)-O(\log_2n)</script>、<script type="math/tex">O(n\sqrt{n})-O(\sqrt{n})</script>来做。考虑长链剖分。</p><p>首先我们倍增求出<script type="math/tex">f(u,j)</script>表示<script type="math/tex">u</script>的<script type="math/tex">2^j</script>级祖先。另外，对于每个<strong>链顶结点</strong><script type="math/tex">u</script>，我们预处理出<script type="math/tex">u</script>的前<script type="math/tex">h(u)</script>级祖先和<script type="math/tex">u</script>这条链上的结点序列。</p><p>则我们先求出一个最大的<script type="math/tex">j</script>使得<script type="math/tex">2^j\le k</script>。设<script type="math/tex">u'=f(u,j),k'=k-2^j</script>，那么我们要求的就是<script type="math/tex">u'</script>的<script type="math/tex">k'</script>级祖先。</p><p>由于<script type="math/tex">h(u')\ge 2^j&gt;k'</script>，因此<script type="math/tex">u'</script>的<script type="math/tex">k'</script>级祖先要么在<script type="math/tex">u'</script>所在的链上，要么在<script type="math/tex">u'</script>所在链的链顶结点的祖先序列上。两者都可以<script type="math/tex">O(1)</script>查询。因此分类讨论一下即可<script type="math/tex">O(1)</script>查询<script type="math/tex">k</script>级祖先。</p><p>时间复杂度<script type="math/tex">O(n\log_2n)-O(1)</script>。</p><p><a target="_blank" rel="noopener" href="https://gitee.com/sshwy/code/raw/master/kth_ancestor_vijos.cpp">代码</a></p><h2><a id="Cookies" href="#Cookies" class="headerlink" title="Cookies"></a><a target="_blank" rel="noopener" href="https://codeforces.com/contest/1099/problem/F">Cookies</a></h2><blockquote><p>有根树。设<script type="math/tex">d(u)</script>表示一个序列，<script type="math/tex">d(u,j)</script>表示在<script type="math/tex">u</script>的子树中与<script type="math/tex">u</script>距离为<script type="math/tex">j</script>的点的个数。对于每个<script type="math/tex">u</script>询问<script type="math/tex">d(u)</script>中最大值出现第一次的下标。</p></blockquote><p>这题显然可以启发式合并。我们考虑长链剖分。</p><p>容易发现<script type="math/tex">d(u)</script>的长度为<script type="math/tex">h(u)</script>。考虑<script type="math/tex">d(u)</script>继承自<script type="math/tex">d(R_u)</script>。则显然有</p><script type="math/tex;mode=display">d(u,i+1)\gets d(R_u,i)\\
d(u,0)\gets 1</script><p>然后我们遍历<script type="math/tex">u</script>的非继承儿子<script type="math/tex">v</script>，把这些儿子的序列贡献到<script type="math/tex">d(u)</script>上：</p><script type="math/tex;mode=display">d(u,i+1)\gets d(v,i)</script><p>这样就求出了<script type="math/tex">d(u)</script>。然后在贡献和继承的时候顺便更新最大值即可，这样复杂度就是遍历非<script type="math/tex">R_u</script>之外的结点的复杂度，因此总复杂度<script type="math/tex">O(n)</script>。使用 deque 实现，支持在前端插入一个数和随机访问内存，实现起来方便。（只要不遍历长链，复杂度就是对的）</p><p>模板，放出核心代码</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">deque<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">*</span>d<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> <span class="token keyword">long</span> ans<span class="token punctuation">;</span>

<span class="token keyword">int</span> dep<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>hgh<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> a<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">dfs1</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">,</span><span class="token keyword">int</span> p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    dep<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span>dep<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    hgh<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">FORe</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>u<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">!=</span>p<span class="token punctuation">)</span><span class="token function">dfs1</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">,</span>hgh<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>hgh<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span>hgh<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">dfs2</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">,</span><span class="token keyword">int</span> p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> mx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>son<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">FORe</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>u<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">!=</span>p<span class="token operator">&amp;&amp;</span>hgh<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token operator">></span>mx<span class="token punctuation">)</span>mx<span class="token operator">=</span>hgh<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">,</span>son<span class="token operator">=</span>v<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>son<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        d<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">new</span> deque<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token punctuation">;</span>
        d<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">pb</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">dfs2</span><span class="token punctuation">(</span>son<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FORe</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>u<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">!=</span>p<span class="token operator">&amp;&amp;</span>v<span class="token operator">!=</span>son<span class="token punctuation">)</span><span class="token function">dfs2</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 继承 son</span>
    d<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span>d<span class="token punctuation">[</span>son<span class="token punctuation">]</span><span class="token punctuation">;</span>
    d<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">push_front</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>son<span class="token punctuation">]</span><span class="token operator">></span>b<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">)</span>b<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span>b<span class="token punctuation">[</span>son<span class="token punctuation">]</span><span class="token punctuation">,</span>a<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span>a<span class="token punctuation">[</span>son<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>son<span class="token punctuation">]</span><span class="token operator">==</span>b<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">)</span>a<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">min</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span>a<span class="token punctuation">[</span>son<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 合并其他儿子的答案</span>
    <span class="token function">FORe</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>u<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">==</span>p<span class="token operator">||</span>v<span class="token operator">==</span>son<span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> lim<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>d<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token operator">-></span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> mx2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>ans<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">FOR</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>lim<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>d<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token operator">*</span>d<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>d<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">></span>mx2<span class="token punctuation">)</span>mx2<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">*</span>d<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ans<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>mx2<span class="token operator">></span>b<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">)</span>b<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span>mx2<span class="token punctuation">,</span>a<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span>ans<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>mx2<span class="token operator">==</span>b<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">)</span>a<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">min</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span>ans<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a target="_blank" rel="noopener" href="https://gitee.com/sshwy/code/raw/master/codeforces/1009f.cpp">完整代码</a></p><h2><a id="谈笑风生" href="#谈笑风生" class="headerlink" title="谈笑风生"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P3899">谈笑风生</a></h2><p>考虑长链剖分。设<script type="math/tex">f(u,i)</script>表示子树<script type="math/tex">u</script>内与<script type="math/tex">u</script>距离为<script type="math/tex">i</script>的结点的子树大小减 1 的和：</p><script type="math/tex;mode=display">f(u,i)=\sum_{v\in T_u,dep(u)+i=dep(v)}S(v)-1</script><p>则分两种情况讨论：</p><ol><li><script type="math/tex">b</script>是<script type="math/tex">a</script>的祖先，则方案数为<script type="math/tex">\min(dep(a)-1,k)(S(a)-1)</script>；</li><li><script type="math/tex">a</script>是<script type="math/tex">b</script>的祖先，则方案数为<script type="math/tex">\sum_{i=1}^{\min(k,h(a)-1)}f(u,i)</script>。</li></ol><p>在继承的时候</p><script type="math/tex;mode=display">f(u,i+1)\gets f(R_u,i)\\
f(u,0)\gets S(u)-1</script><p>在贡献的时候</p><script type="math/tex;mode=display">f(u,i+1)\gets f(v,i)</script><p>考虑到我们询问的时候是一个区间和的形式，因此把<script type="math/tex">f(u)</script>做后缀和处理即可。这样可以<script type="math/tex">O(1)</script>计算询问，也可以<script type="math/tex">O(1)</script>转移，复杂度<script type="math/tex">O(n)</script>。</p><p>这是指针版的写法，感觉更好用：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">long</span> <span class="token keyword">long</span> BIN<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>lb<span class="token punctuation">;</span>
<span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span>f<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">long</span> <span class="token keyword">long</span> ans<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> hgh<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>dep<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>sz<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
vector<span class="token operator">&lt;</span> pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">></span> qry<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">dfs1</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">,</span><span class="token keyword">int</span> p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    hgh<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>dep<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span>dep<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>sz<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">FORe</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>u<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">!=</span>p<span class="token punctuation">)</span><span class="token function">dfs1</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">,</span>sz<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">+=</span>sz<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">,</span>hgh<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>hgh<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">,</span>hgh<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">dfs2</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token punctuation">,</span><span class="token keyword">int</span> p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token operator">++</span>lb<span class="token punctuation">;</span>
    <span class="token keyword">int</span> mx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>son<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">FORe</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>u<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">!=</span>p<span class="token operator">&amp;&amp;</span>hgh<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token operator">></span>mx<span class="token punctuation">)</span>mx<span class="token operator">=</span>hgh<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">,</span>son<span class="token operator">=</span>v<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>son<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        f<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span>BIN<span class="token operator">+</span>lb<span class="token punctuation">;</span><span class="token comment">// 指针赋值</span>
        f<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>sz<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">dfs2</span><span class="token punctuation">(</span>son<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FORe</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>u<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">!=</span>p<span class="token operator">&amp;&amp;</span>v<span class="token operator">!=</span>son<span class="token punctuation">)</span><span class="token function">dfs2</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>

    f<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">=</span>f<span class="token punctuation">[</span>son<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    f<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>sz<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">+</span>f<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 后缀和</span>

    <span class="token function">FORe</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>u<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">==</span>p<span class="token operator">||</span>v<span class="token operator">==</span>son<span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token function">FOR</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>hgh<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>f<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+=</span>f<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        f<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+=</span>f<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 后缀和</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 处理询问</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>pii p<span class="token operator">:</span>qry<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> id<span class="token operator">=</span>p<span class="token punctuation">.</span>fi<span class="token punctuation">,</span>k<span class="token operator">=</span>p<span class="token punctuation">.</span>se<span class="token punctuation">;</span>
        ans<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">+=</span><span class="token number">1ll</span><span class="token operator">*</span><span class="token function">min</span><span class="token punctuation">(</span>dep<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>sz<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ans<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token operator">+=</span>f<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token punctuation">(</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token operator">>=</span>hgh<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token operator">?</span><span class="token number">0</span><span class="token operator">:</span>f<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a target="_blank" rel="noopener" href="https://gitee.com/sshwy/code/raw/master/luogu/3899.cpp">完整代码</a></p><h2><a id="攻略" href="#攻略" class="headerlink" title="攻略"></a><a target="_blank" rel="noopener" href="https://darkbzoj.tk/problem/3252">攻略</a></h2><p>把一个点拆成其权值长度的链。</p><p>然后在新的树上长链剖分后选前 k 大的链即可。</p><p><a target="_blank" rel="noopener" href="https://gitee.com/sshwy/code/raw/master/bzoj/3252.cpp">代码</a></p><h2><a id="HOTEL-加强版" href="#HOTEL-加强版" class="headerlink" title="HOTEL 加强版"></a><a target="_blank" rel="noopener" href="https://darkbzoj.tk/problem/4543">HOTEL 加强版</a></h2><blockquote><p>一棵树，求三个互不相同的点并且两两距离相等的方案数。</p></blockquote><p>记<script type="math/tex">f(u,i)</script>表示子树<script type="math/tex">u</script>中与<script type="math/tex">u</script>距离<script type="math/tex">i</script>的点的个数，<script type="math/tex">g(u,i)</script>表示子树<script type="math/tex">u</script>中的二元组<script type="math/tex">(x,y)</script>的个数，满足<script type="math/tex">x,y</script>到其 LCA 的距离都为<script type="math/tex">d</script>且这个 LCA 到<script type="math/tex">u</script>的距离为<script type="math/tex">d-i</script>。即距离差为<script type="math/tex">i</script>的二元组的个数。</p><p>考虑继承</p><script type="math/tex;mode=display">f(u,i)\gets f(R_u,i-1)\\
f(u,0)\gets 1\\
g(u,i)\gets g(R_u,i+1)</script><p>考虑贡献</p><script type="math/tex;mode=display">f(u,i+1)\gets f(v,i)\\
g(u,i)\gets g(v,i+1)\\
g(u,i)\gets f(u,i)f(v,i-1)</script><p>这里的<script type="math/tex">f(u),g(u)</script>是指在合并完了<script type="math/tex">v</script>之前的子节点的 DP 值。</p><p>考虑统计答案，我们可以在上述贡献的<strong>过程</strong>中统计：</p><script type="math/tex;mode=display">Ans\gets f(u,i-1)g(u,i)\\
Ans\gets f(v,i)g(u,i+1)\\</script><p>在计算完<script type="math/tex">f(u),g(u)</script>之后，还有<script type="math/tex">Ans\gets g(u,0)</script>。</p><p>注意这些转移的边界，以及他们的转移顺序。</p><p><a target="_blank" rel="noopener" href="https://gitee.com/sshwy/code/raw/master/bzoj/4543.cpp">代码</a></p><h2><a id="重建计划" href="#重建计划" class="headerlink" title="重建计划"></a><a target="_blank" rel="noopener" href="https://darkbzoj.tk/problem/1758">重建计划</a></h2><p>首先二分答案，则边权变成<script type="math/tex">w-mid</script>，问题转化为是否存在一条长度在<script type="math/tex">[L,U]</script>的路径权值非负。</p><p>如法炮制，设<script type="math/tex">f(u,i)</script>表示<script type="math/tex">u</script>的子树内以<script type="math/tex">u</script>为端点的长度为<script type="math/tex">i</script>的路径的权值最大值。</p><p>继承</p><script type="math/tex;mode=display">f(u,i)\gets f(R_u,i)+w(R_u)-mid\\
f(u,1)\gets w(R_u)-mid</script><p>贡献</p><script type="math/tex;mode=display">f(u,i+1)\gets f(v,i)+w(v)-mid\\
f(u,1)\gets w(v)-mid</script><p>这里的转移是取<script type="math/tex">\max</script>。在合并的时候顺便检查是否存在<script type="math/tex">x,y</script>使得<script type="math/tex">f(u,x)+f(v,y)+w(v)-mid&gt;0</script>，则我们枚举<script type="math/tex">y</script>的时候查询区间最大值即可。因此使用线段树维护上述转移，需要支持区间加、单点对某个数取<script type="math/tex">\max</script>、询问区间<script type="math/tex">\max</script>。</p><p>时间复杂度<script type="math/tex">O(n\log_2n)</script>。</p><p><a target="_blank" rel="noopener" href="https://gitee.com/sshwy/code/raw/master/bzoj/1758.cpp">代码</a></p><p><a id="fn_1" class="headerlink" title="1"></a><sup>1</sup>. <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Heavy_path_decomposition">https://en.wikipedia.org/wiki/Heavy_path_decomposition</a><a href="#reffn_1" title="Jump back to footnote [1] in the text."> &#8617;</a></p></div><hr><h3><span class="iconfont icon-history" style="padding-right:5px;font-size:1em"></span>修订记录</h3><div class="post-history-list"><ol reversed><li class="post-history-item">2021年3月28日 第2次修订</li><li class="post-history-item">2019年11月25日 创建文章</li></ol></div><div class="post-footer"><hr><div class="next-post"><span class="iconfont icon-arrow-left-circle"></span> <a href="/Math/Faulhaber/">自然数幂和小结</a></div><div class="prev-post"><a href="/Math/Polynomial/Think-via-GF/">生成函数回炉重造 </a><span class="iconfont icon-arrow-right-circle"></span></div></div></article></main></body><div class="side-button"><div id="comment-button" class="button" title="Valine Comment"><span class="iconfont icon-comment"></span></div><div id="darkmode-button" class="button" title="Switch between day and night"><span class="iconfont icon-moonbyueliang"></span></div><div id="top" class="button" title="Back to top"><span class="iconfont icon-arrowup"></span></div></div><footer id="footer" style="margin:3em 0 2em 0;text-align:center;line-height:1.4em"><span class="post-wordcount iconfont icon-text"></span> 全站约 404,069 字<div class="license" style="padding:0 10px"><span>本站所有文章遵循许可协议 <a target="_blank" rel="license noreferrer noopener" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a></span></div><div class="credit"><span>Themed <a href="https://github.com/sshwy/hexo-theme-essence" target="_blank" rel="noreferrer noopener">Essence v1.9.11</a> | Powered by <a href="http://hexo.io" target="_blank" rel="noreferrer noopener">Hexo</a></span></div><div class="friends"><span class="friend-link-span">友情链接 </span><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://carol-xrl.github.io/"><span class="friend-link-span">Carol </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/GavinZheng"><span class="friend-link-span">GavinZheng </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xryjr233"><span class="friend-link-span">xryjr233 </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/dysyn1314"><span class="friend-link-span" title="为什么我的头常常变绿？因为…… "><span style="font-weight:700"><span class="codeforces p">dy</span><span class="codeforces m">syn</span><span class="codeforces p">1314</span></span> </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://blog.aor.sd.cn"><span class="friend-link-span">RainAir </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/lcyfrog"><span class="friend-link-span">lcyfrog </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/maoyiting"><span class="friend-link-span">/hanx/se</span></a></div><div class="copyright"><span>Copyright &copy; 2019-present - Sshwy</span></div></footer><script src="/js/ssimple.js?20250423.js"></script><script src="https://pv.sohu.com/cityjson?ie=utf-8.js" defer></script></html>