<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta name="keywords" content=""><meta name="description" content="Sshwy 的个人博客"><meta name="generator" content="Hexo 6.3.0"><title>虚树入门 - Sshwy&#39;s Notes</title><link rel="shortcut icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/ssimple.css?20250423.css"><link rel="stylesheet" href="/iconfont/iconfont.css?20250423.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js" crossorigin="anonymous"></script><script>document.addEventListener("DOMContentLoaded",function(){window.renderKatex()})</script></head><body><header><div class="header" style="width:100%"><div class="header-inner" style="position:fixed;z-index:20;top:0;left:0"><div class="header-content" style="max-width:1200px;margin:auto"><div class="blog-title"><span class="iconfont icon-menu1" id="menu-button"></span> <a href="/" class="logo header-title">Sshwy&#39;s Notes</a><div class="mobile-search"><input type="text"> <span class="iconfont icon-search mobile-search-icon"></span> <span class="iconfont icon-baseline-close-px search-close-icon"></span></div></div><div class="navbar" id="menu-list"><ul class="menu"><li class="menu-item"><a href="/archives/" class="menu-item-link"><span class="menu-item-icon iconfont icon-work"></span> Archives</a></li><li class="menu-item"><a href="/directory/" class="menu-item-link"><span class="menu-item-icon iconfont icon-folder-close"></span> Directory</a></li><li class="menu-item"><a href="/about/" class="menu-item-link"><span class="menu-item-icon iconfont icon-user"></span> About</a></li><li class="menu-item"><a href="/static/beibishi2023" class="menu-item-link"><span class="menu-item-icon iconfont icon-favorite"></span> NOI 背笔试</a></li></ul></div><div class="search"><input type="text"> <span class="iconfont icon-search search-icon"></span> <span class="iconfont icon-baseline-close-px search-close-icon"></span></div></div></div><div class="search-shadow"></div><div class="search-box"><div class="search-container"><div class="search-container-inner"><div class="search-data-status"><span>Fetching search data...</span></div><div class="search-count"></div><div class="search-result"></div></div></div></div></div></header><main class="main"><article class="post"><div class="post-title"><h1 class="page-title">虚树入门</h1></div><div class="post-meta"><div class="post-info"><span class="post-info-item post-time" title="2020年1月27日星期一晚上7点04分 (CST+08:00)"><span class="info-icon iconfont icon-time"></span>更新于 2020年1月27日 </span><span class="icon infosep"></span><span class="post-info-item post-wordcount"> <span class="info-icon iconfont icon-text"></span>约 1,449 字</span></div><div class="post-directory"><span class="iconfont icon-folder-close"></span> <a class="directory" href="/directory">Home</a> <a class="directory" href="/directory/"></a> <span class="icon smallarrow"></span> <a class="directory" href="/directory/Data-Structure/">数据结构 </a><span class="icon smallarrow"></span> 当前文章</div><div class="post-tags"><span class="tag"><span class="meta-icon iconfont icon-tag"></span><a class="tag" href="/tags/Notes/">Notes</a></span></div><hr></div><div class="toc"><h2 class="toc-title"><span class="iconfont icon-explain" style="font-size:1em;padding-right:5px"></span>文章目录</h2><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#虚树"><span class="toc-number">1.</span> <span class="toc-text">虚树</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#虚树的构建"><span class="toc-number">2.</span> <span class="toc-text">虚树的构建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#「例-1」-SDOI2011-消耗战"><span class="toc-number">3.</span> <span class="toc-text">「例 1」 SDOI2011 消耗战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#「例-2」-ZR982-黄队"><span class="toc-number">4.</span> <span class="toc-text">「例 2」 ZR982 黄队</span></a></li></ol></div><hr></div><div class="post-content"><h2><a id="虚树" href="#虚树" class="headerlink" title="虚树"></a>虚树</h2><p>虚树是指对一棵树<script type="math/tex">T=(V,E)</script>，取其点集的子集<script type="math/tex">S\subseteq V</script>作为关键点集，将关键点以及他们两两之间的 LCA 构成的点集<script type="math/tex">S'</script>拿出来建立一棵树，这棵树称为<script type="math/tex">T</script>的关于<script type="math/tex">S</script>的<strong>虚树</strong>。</p><p>虚树的意义是它只包含了关键点以及 LCA，但也维护了原树的结构特征，方便我们对信息的处理。</p><p><img src="../../images/Virtual-Tree-1.png" alt="Virtual-Tree-1"></p><h2><a id="虚树的构建" href="#虚树的构建" class="headerlink" title="虚树的构建"></a>虚树的构建</h2><p>我们对原树先做一次 DFS，求出每个点的 DFS 序。然后把关键点按照 DFS 序排序。考虑增量构造。我们用栈维护当前虚树的右链。添加一个结点相当于删掉末端的一些点，再把这个点加入到右链上。</p><p>在弹栈的时候就把这条边加到虚树上。最后把栈里所有的点依次连边加到虚树上即可。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> s<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>tp<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">build_virtual_tree</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span> V<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> root<span class="token operator">=</span>V<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token operator">:</span>V<span class="token punctuation">)</span>root<span class="token operator">=</span><span class="token function">lca</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">[</span>tp<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>root<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> u<span class="token operator">:</span>V<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> y<span class="token operator">=</span><span class="token function">lca</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>tp<span class="token operator">></span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>dep<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token operator">&lt;</span>dep<span class="token punctuation">[</span>s<span class="token punctuation">[</span>tp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token function">Vadd</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>tp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">W</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>tp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">--</span>tp<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">==</span>s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>tp<span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">==</span>s<span class="token punctuation">[</span>tp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">Vadd</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">W</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">--</span>tp<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token function">Vadd</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">W</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token operator">=</span>y<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        s<span class="token punctuation">[</span><span class="token operator">++</span>tp<span class="token punctuation">]</span><span class="token operator">=</span>u<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>tp<span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">Vadd</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>tp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">W</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>tp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>s<span class="token punctuation">[</span>tp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">--</span>tp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// s 和 tp 是栈</span>
<span class="token comment">// V 表示关键点集，并且已经排好序。</span>
<span class="token comment">// Vadd 表示在虚树上加上这条边，W 表示边权</span>
<span class="token comment">// root 在特殊情况也可能是 T 的根</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>考虑到排序的复杂度，虚树的构建复杂度是<script type="math/tex">O(|S|\log_2|S|)</script>的。</p><p>小性质：虚树的规模是<script type="math/tex">\Theta(|S|)</script>的。</p><h2><a id="「例-1」-SDOI2011-消耗战" href="#「例-1」-SDOI2011-消耗战" class="headerlink" title="「例 1」 SDOI2011 消耗战"></a>「例 1」 SDOI2011 消耗战</h2><blockquote><p>给出一棵边带权的树<script type="math/tex">T=(V,E)</script>，多次询问，每次给出一个点集<script type="math/tex">S\subseteq V</script>，<script type="math/tex">1\notin S</script>，要求删掉权值和最小的边使得 1 与<script type="math/tex">S</script>中任意一个点都不连通。求这个最小权值和。</p><p><script type="math/tex">|V|\le 2.5\times 10^5,|E|=|V|-1,\sum |S|\le 5\times 10^5</script>。</p></blockquote><p>显然的虚树题。每次询问，对<script type="math/tex">S\cup\{1\}</script>建虚树，边权置为两点间边权最小值。那么我们就只需要在这个虚树做原问题即可。由于虚树的规模是<script type="math/tex">O(|S|)</script>，考虑到排序的复杂度，则总复杂度为<script type="math/tex">O(\sum |S|\log_2|V|)</script>。</p><p><a target="_blank" rel="noopener" href="https://gitee.com/sshwy/code/raw/master/luogu/2495.cpp">代码</a></p><h2><a id="「例-2」-ZR982-黄队" href="#「例-2」-ZR982-黄队" class="headerlink" title="「例 2」 ZR982 黄队"></a>「例 2」 ZR982 黄队</h2><blockquote><p>有一棵<script type="math/tex">n</script>个节点的树，其中所有的树边<script type="math/tex">1</script>到<script type="math/tex">n−1</script>标号。定义<script type="math/tex">\delta(v,r)</script>为<script type="math/tex">v</script>经过由标号不超过<script type="math/tex">r</script>的边构成的路径到达的点集。</p><p>现在有<script type="math/tex">q</script>个询问，每个询问给你一组点<script type="math/tex">v_1,v_2,\cdots,v_k</script>，求<script type="math/tex">(r_1,r_2,\cdots ,r_k)</script>这样的<script type="math/tex">k</script>元组个数，满足<script type="math/tex">0\le r_i\le n−1</script>且<script type="math/tex">δ(v_i,r_i)</script>这些点集两两不交。</p><p>由于答案很大，请输出对<script type="math/tex">10^9+7</script>取模的值。</p><p><script type="math/tex">1\leq n, q, \sum k\leq 2\times 10^5</script>.</p></blockquote><p>首先思考<script type="math/tex">\delta(u,x)</script>和<script type="math/tex">\delta(v,y)</script>不相交的条件是什么。设<script type="math/tex">w(u,v)</script>表示<script type="math/tex">u</script>到<script type="math/tex">v</script>的边的编号最大值，那么充要条件就是<script type="math/tex">x&lt;w(u,v)</script>且<script type="math/tex">y&lt;w(u,v)</script>。</p><p>题目中要求的是两两不交，那么意味着<script type="math/tex">r_i&lt;\min_{1\le j\le k,j\ne i} w(v_i,v_j)</script>。</p><p>考虑离线并查集。把边权从小到大排序。那么考虑当前<script type="math/tex">(u,v,w)</script>这条边，则<script type="math/tex">u</script>的连通块和<script type="math/tex">v</script>的连通块边权都小于<script type="math/tex">w</script>，因此如果<script type="math/tex">u</script>中只有一个关键点，<script type="math/tex">v</script>中有至少一个关键点，那么<script type="math/tex">u</script>的关键点对应的<script type="math/tex">r</script>的限制就是<script type="math/tex">w</script>。对称情况是一样的。其他情况，是不能确定限制的值的。</p><p>最后把限制都乘起来就是答案。</p><p>这个过程显然是可以在虚树上做的。</p><p>总复杂度<script type="math/tex">O(n+\sum k\log_2n)</script>。</p></div><hr><h3><span class="iconfont icon-history" style="padding-right:5px;font-size:1em"></span>修订记录</h3><div class="post-history-list"><ol reversed><li class="post-history-item">2020年1月27日 创建文章</li></ol></div><div class="post-footer"><hr><div class="next-post"><span class="iconfont icon-arrow-left-circle"></span> <a href="/Math/Fomula-of-Sphere/">球体积公式推导</a></div><div class="prev-post"><a href="/String/Suffix-Array/">后缀数组 </a><span class="iconfont icon-arrow-right-circle"></span></div></div></article></main></body><div class="side-button"><div id="comment-button" class="button" title="Valine Comment"><span class="iconfont icon-comment"></span></div><div id="darkmode-button" class="button" title="Switch between day and night"><span class="iconfont icon-moonbyueliang"></span></div><div id="top" class="button" title="Back to top"><span class="iconfont icon-arrowup"></span></div></div><footer id="footer" style="margin:3em 0 2em 0;text-align:center;line-height:1.4em"><span class="post-wordcount iconfont icon-text"></span> 全站约 404,069 字<div class="license" style="padding:0 10px"><span>本站所有文章遵循许可协议 <a target="_blank" rel="license noreferrer noopener" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a></span></div><div class="credit"><span>Themed <a href="https://github.com/sshwy/hexo-theme-essence" target="_blank" rel="noreferrer noopener">Essence v1.9.11</a> | Powered by <a href="http://hexo.io" target="_blank" rel="noreferrer noopener">Hexo</a></span></div><div class="friends"><span class="friend-link-span">友情链接 </span><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://carol-xrl.github.io/"><span class="friend-link-span">Carol </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/GavinZheng"><span class="friend-link-span">GavinZheng </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/xryjr233"><span class="friend-link-span">xryjr233 </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/dysyn1314"><span class="friend-link-span" title="为什么我的头常常变绿？因为…… "><span style="font-weight:700"><span class="codeforces p">dy</span><span class="codeforces m">syn</span><span class="codeforces p">1314</span></span> </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://blog.aor.sd.cn"><span class="friend-link-span">RainAir </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/lcyfrog"><span class="friend-link-span">lcyfrog </span></a><span class="icon friendsep"></span> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/maoyiting"><span class="friend-link-span">/hanx/se</span></a></div><div class="copyright"><span>Copyright &copy; 2019-present - Sshwy</span></div></footer><script src="/js/ssimple.js?20250423.js"></script><script src="https://pv.sohu.com/cityjson?ie=utf-8.js" defer></script></html>